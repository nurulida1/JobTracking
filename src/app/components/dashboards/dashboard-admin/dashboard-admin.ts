import { CommonModule } from '@angular/common';
import {
  ChangeDetectionStrategy,
  ChangeDetectorRef,
  Component,
  inject,
  Input,
} from '@angular/core';
import { DashboardSummary } from '../../../models/AppModels';
import { ChartModule } from 'primeng/chart';
import { RouterLink } from '@angular/router';
import { LoadingService } from '../../../services/loading.service';
import { AppService } from '../../../services/appService.service';
import { forkJoin, Subject, takeUntil } from 'rxjs';
import { TableModule } from 'primeng/table';

@Component({
  selector: 'app-dashboard-admin',
  imports: [CommonModule, ChartModule, RouterLink, TableModule],
  template: `
    <div class="w-full pt-10 pb-20 md:p-2">
      <div class="grid md:grid-cols-2 gap-4 h-[45%] md:px-10">
        <div class="flex flex-col gap-5">
          <div
            class="bg-gray-50 p-2 md:p-3 rounded-xl border border-gray-300 shadow-md flex flex-col"
          >
            <h3
              class="md:text-lg font-semibold mb-4 md:mb-3 text-blue-400 tracking-wider"
            >
              Quotations
            </h3>
            <div class="flex mb-4 gap-2">
              <div
                class="text-center p-2 rounded-md bg-[#FFB128] shadow-lg shadow-black/30 flex-1"
              >
                <div
                  class="text-4xl font-semibold text-white text-shadow-md tracking-widest"
                >
                  {{ dashboardCount?.summary?.quotations?.pending }}
                </div>
                <div
                  class="pt-2 text-xs text-white text-shadow-lg tracking-wider"
                >
                  Pending Approval
                </div>
              </div>
              <div
                class="text-center flex-1 p-2 rounded-md bg-[#36e72f] shadow-lg shadow-black/30"
              >
                <div
                  class="text-4xl font-semibold tracking-widest text-white text-shadow-lg"
                >
                  {{ dashboardCount?.summary?.quotations?.approved }}
                </div>
                <div
                  class="pt-2 text-xs text-white text-shadow-lg tracking-wider"
                >
                  Approved
                </div>
              </div>
              <div
                class="text-center flex-1 p-2 rounded-md bg-[#e72f2f] shadow-lg shadow-black/30"
              >
                <div
                  class="text-4xl font-semibold tracking-widest text-white text-shadow-lg"
                >
                  {{ dashboardCount?.summary?.quotations?.rejected }}
                </div>
                <div
                  class="pt-2 text-xs text-white text-shadow-lg tracking-wider"
                >
                  Rejected
                </div>
              </div>
            </div>
          </div>

          <div class="rounded-xl shadow-md flex flex-col">
            <div
              class="text-sm rounded-t-xl bg-blue-400 text-white text-shadow-md text-shadow-black/20 font-semibold tracking-widest px-4 py-3 border border-gray-200"
            >
              Quotes Generated By Day
            </div>
            <div
              class="bg-gray-50 px-4 flex-grow rounded-lg border py-2 border-white/10 flex items-center justify-center"
            >
              <p-chart
                type="line"
                [data]="quotationChartData"
                [options]="quotationChartOptions"
                style="width: 100%;"
              ></p-chart>
            </div>
          </div>
        </div>
        <div
          class="rounded-xl border border-gray-300 shadow-md flex flex-col items-center"
        >
          <h3
            class="text-lg font-semibold bg-pink-400 text-white tracking-widest text-shadow-md text-shadow-black/30 w-full text-center rounded-t-xl px-4 py-3"
          >
            Work Orders (WO)
          </h3>
          <div
            class="bg-gray-50 rounded-b-xl pt-10 md:pt-0 flex flex-col gap-30 items-center justify-center w-full h-full"
          >
            <div class="relative w-40 h-40 flex items-center justify-center">
              <svg viewBox="0 0 36 36" class="absolute w-full h-full">
                <path
                  class="text-gray-700"
                  fill="none"
                  stroke="currentColor"
                  d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831"
                  stroke-width="4"
                  stroke-dasharray="100, 100"
                />
                <path
                  class="text-cyan-500"
                  fill="none"
                  stroke="currentColor"
                  d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831"
                  stroke-width="4"
                  stroke-dasharray="48, 100"
                  stroke-dashoffset="0"
                />
                <path
                  class="text-fuchsia-500"
                  fill="none"
                  stroke="currentColor"
                  d="M18 2.0845a15.9155 15.9155 0 0 1 0 31.831"
                  stroke-width="4"
                  stroke-dasharray="12, 100"
                  stroke-dashoffset="-48"
                />
              </svg>
              <div class="absolute text-5xl font-bold">
                {{ dashboardCount?.summary?.workOrders }}
              </div>
            </div>
            <div class="flex justify-around w-full text-sm pb-2">
              <div class="text-center">
                <div
                  class="w-2 h-2 rounded-full bg-cyan-500 inline-block mr-1"
                ></div>
                <span class="text-gray-400">Active Jobs</span>
              </div>
              <div class="text-center">
                <div
                  class="w-2 h-2 rounded-full bg-fuchsia-500 inline-block mr-1"
                ></div>
                <span class="text-gray-400">Delayed Jobs</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 h-[50%] md:px-10 mt-3">
        <div
          class="bg-gray-50 rounded-xl border border-gray-300 shadow-md flex flex-col"
        >
          <h3
            class="text-lg px-4 py-2 rounded-t-xl font-semibold mb-3 bg-cyan-400 text-white text-shadow-lg"
          >
            Job Tracking
          </h3>
          <div class="flex space-x-8 p-4">
            <div class="text-center flex-1 border-r border-gray-300">
              <div class="text-4xl font-semibold tracking-widest text-gray-600">
                {{ dashboardCount?.summary?.jobs?.active }}
              </div>
              <div class="text-sm text-gray-400">Active Jobs</div>
            </div>
            <div class="text-center flex-1">
              <div
                class="text-4xl font-semibold tracking-widest text-yellow-400"
              >
                {{ dashboardCount?.summary?.jobs?.pending }}
              </div>
              <div class="text-sm text-gray-400">Pending</div>
            </div>
            <div class="text-center flex-1 border-l border-gray-300">
              <div class="text-4xl font-semibold tracking-widest text-red-400">
                {{ dashboardCount?.summary?.jobs?.delayed }}
              </div>
              <div class="text-sm text-gray-400">Delayed</div>
            </div>
          </div>
          <div class="p-4">
            <div class="text-sm text-gray-700 tracking-wider">Latest Job</div>
            <div class="mt-2 flex flex-row items-center gap-2">
              <i class="pi pi-circle-on !text-[5px]"></i>
              <div class="text-xs text-gray-500 tracking-wider">
                Job 1 in progress
              </div>
            </div>
          </div>
          <div class="px-4 pb-4">
            <div class="border-b border-gray-200"></div>
          </div>
          <div class="flex justify-center px-4 pb-4 gap-3">
            <button
              [routerLink]="'/quotation/form'"
              class="px-5 py-2 text-gray-700 text-sm tracking-wider border-[#40A0AC] border-2 cursor-pointer rounded-md font-semibold transition duration-200 hover:bg-cyan-200"
            >
              Create New Quote
            </button>
            <button
              class="cursor-pointer px-5 py-3 text-sm tracking-wider bg-gray-200 hover:bg-gray-300 rounded-md transition duration-200"
            >
              View Reports
            </button>
          </div>
        </div>

        <div
          class="bg-gray-50 rounded-xl border border-gray-300 shadow-md flex flex-col md:mb-0 mb-10"
        >
          <h3
            class="px-4 py-3 shadow-sm rounded-t-xl text-lg font-semibold mb-3 text-white text-shadow-lg bg-yellow-400"
          >
            Role Requests
          </h3>
          <div class="flex justify-center p-4 gap-2">
            <div class="p-2 flex-1 bg-white shadow-md rounded-md">
              <div class="flex flex-row items-center border justify-between">
                <div
                  class="text-4xl font-semibold tracking-widest text-yellow-500 text-shadow-md"
                >
                  {{ dashboardCount?.summary?.roleRequests?.pending }}
                </div>
                <div class="flex flex-col justify-between">
                  <i class="pi pi-hourglass"></i>
                  <div
                    class="text-right text-xs tracking-wider pt-1 text-gray-400"
                  >
                    Pending
                  </div>
                </div>
              </div>
            </div>
            <div class="p-2 flex-1 bg-white shadow-md rounded-md">
              <div
                class="text-4xl font-semibold tracking-widest text-green-500 text-shadow-md"
              >
                {{ dashboardCount?.summary?.roleRequests?.approved }}
              </div>
              <div class="text-right text-xs tracking-wider pt-1 text-gray-400">
                Approved
              </div>
            </div>
          </div>
          <div class="px-4 pb-3">
            <div class="border-b border-gray-200"></div>
          </div>
          <div class="px-4 pb-3 text-sm tracking-wider text-gray-600">
            Top 3 Pending Role Requests
          </div>
          <div class="px-4 pb-4 flex-grow">
            <p-table
              dataKey="id"
              [value]="dashboardCount?.roleRequestsDetails || []"
              size="small"
              [tableStyle]="{ 'min-width': '10rem' }"
              tableStyleClass="!w-full border border-gray-200"
              styleClass="!w-full"
            >
              <ng-template #header>
                <tr>
                  <th
                    class="!bg-yellow-400 !text-white !text-shadow-md !text-center text-xs tracking-wider"
                  >
                    Username
                  </th>
                  <th
                    class="!bg-yellow-400 !text-white !text-shadow-md !text-center text-xs tracking-wider"
                  >
                    Requested Role
                  </th>
                  <th
                    class="!bg-yellow-400 !text-white !text-shadow-md !text-center text-xs tracking-wider"
                  >
                    Requested At
                  </th>
                </tr>
              </ng-template>
              <ng-template #body let-data>
                <tr>
                  <td class="!text-center text-xs">{{ data.userFullName }}</td>
                  <td class="!text-center text-xs">{{ data.requestedRole }}</td>
                  <td class="!text-center text-xs">
                    {{ data.createdAt | date : 'dd/MM/YYYY' }}
                  </td>
                </tr>
              </ng-template>
              <ng-template #emptymessage>
                <tr colspan="100%">
                  <td>No requested role</td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </div>
    </div>
  `,
  styleUrl: './dashboard-admin.less',
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class DashboardAdmin {
  @Input() dashboardCount: DashboardSummary | null = null;

  @Input() quotationChartData: any;
  @Input() quotationChartOptions: any;

  private readonly loadingService = inject(LoadingService);
  private readonly appService = inject(AppService);
  private readonly cdr = inject(ChangeDetectorRef);
  protected ngUnsubscribe: Subject<void> = new Subject<void>();

  isMobile = window.innerWidth < 770;
  notifications: { message: string; time: Date }[] = [];

  ngOnInit(): void {
    const requests: any = {
      dashboardCount: this.appService.GetDashboardAdmin(),
      quotationChart: this.appService.QuotationChart(),
    };

    forkJoin(requests)
      .pipe(takeUntil(this.ngUnsubscribe))
      .subscribe({
        next: (res: any) => {
          this.dashboardCount = res.dashboardCount;

          if (!this.isMobile) {
            this.notifications = res.notifications;
          }

          // ðŸ†• Handle quotation chart data
          const chartData = res.quotationChart || [];
          const labels = chartData.map((item: any) =>
            new Date(item.date).toLocaleDateString('en-MY', {
              day: '2-digit',
              month: 'short',
            })
          );
          const data = chartData.map((item: any) => item.count);

          this.quotationChartData = {
            labels,
            datasets: [
              {
                data,
                borderColor: '#42A5F5',
                tension: 0.4,
                fill: false,
              },
            ],
          };

          this.quotationChartOptions = {
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: { color: '#A0AEC0' },
                grid: { color: 'rgba(255,255,255,0.1)' },
              },
              y: {
                ticks: {
                  color: '#A0AEC0',
                  precision: 0,
                  callback: function (value: number) {
                    return Math.floor(value);
                  },
                },
                grid: { color: 'rgba(255,255,255,0.1)' },
              },
            },
          };

          this.cdr.detectChanges();
        },
        error: (err) => {
          console.error(err);
          this.loadingService.stop();
        },
        complete: () => {
          this.loadingService.stop();
        },
      });
  }
}
